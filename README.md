# Setup a new Rails project using Docker and Compose
Based on https://docs.docker.com/compose/rails/
And https://github.com/pacuna/rails5-docker-alpine

## Goals:
- Be able to setup and run a new Rails project, without having the Ruby and Rails versions installed locally.
- Have an easy development setup that could be run in any machine.
- *(?) Easy production deployment.*

## Easy mode

- Clone this repo on your "projects" folder.
  - `cd ~/projects && git clone https://github.com/evsasse/setup-docker-rails.git`.

- Create a new folder for your new Rails project, with the content on the `banana` folder.
  Let's pretend the name of your project is `my-new-orange-project`.
  - `cp -R setup-docker-rails/banana my-new-orange-project`.

- Enter the new folder, and find and replace every `banana` string on the files by your project's name.
  - `cd my-new-orange-project`;
  - `find . -type f -exec sed -i '' 's/banana/my-new-orange-project/g;s/BANANA/MY_NEW_ORANGE_PROJECT/g' {} +`.

- Build the container image, and create a new Rails project from inside it.
  - `docker-compose run web rails new . --database=postgresql --webpacker --webpack=react --skip-git --force`.

- Replace your `config/database.yml` with one that will reach into the Postgres container.
  - `mv fixed-database.yml config/database.yml`.

- Rebuild the image with the new dependencies added by `rails new`.
  - `docker-compose build`.

- Run the project. You should see the usual **Yay! You’re on Rails!** page.
  - `docker-compose up`.

- This is a good moment to make your initial commit. And send it to a remote repository.
  - `git init`;
  - `git commit -m "Initial commit"`;
  - `git add remote origin https://github.com/evsasse/my-new-orange-project.git`;
  - `git push origin master`.

- Later on, you may want to add Ruby or JS dependencies.
  You should not need to rebuild the container image to do so, in development.
  - Just `docker-compose run web bundle add devise`, and `docker-compose run web yarn add jquery`;
  - Or `docker-compose run web bundle install`, and `docker-compose run web yarn install`, as needed.

- Similarly, you may want to run some migrations.
  - Just `docker-compose run web rails db:migrate` or `docker-compose run web rails db:drop db:create db:migrate db:seed`, etc.

- You can also already remove the clone of this repository.
  - `rm -Rf ../setup-docker-rails`

## Details:
For debugging, and studying.

### Overview:
- Write a Dockerfile that will install Ruby, and the basic Rails dependencies inside the container.
- Set up a volume that will permit changes to the code made inside the container to reflect on our local folder.
- Run `rails new` inside the container, writing the Rails scaffold to our local folder.
- Fix the database connection generated by `rails new`, to be able to reach into the Postgres container that will be run alongside.
- Rebuild the container image to actually build the Rails dependencies into the container.
- Rerun the container to actually run the application.

### Steps:

- Create a `.gitignore` and an identical `.dockerignore`, just by inputting `Rails` on https://gitignore.io

- Write a minimal `Gemfile`, it will be overwritten by `rails new` later:
  ```Gemfile
  source 'https://rubygems.org'

  ruby '2.6.5'

  gem 'rails', '~> 6.0.2'
  ```

- Create an empty `Gemfile.lock`.

- Create a minimal `package.json`, it will be overwritten by `rails new` later.
  ```JSON
  {
    "name": "my-new-orange-project"
  }
  ```

- Create an empty `yarn.lock`.

- Create a minimal `Dockerfile`:
  ```Dockerfile
  FROM ruby:2.6.5-alpine3.10

  # Minimal requirements to run a Rails app
  RUN apk add --no-cache --update \
    build-base \
    linux-headers \
    git \
    postgresql-dev \
    nodejs \
    tzdata \
    yarn \
    bash

  RUN mkdir /home/my-new-orange-project
  WORKDIR /home/my-new-orange-project

  COPY ./Gemfile ./Gemfile.lock ./

  RUN bundle install --jobs 3 --retry 3

  COPY ./package.json ./yarn.lock ./

  RUN yarn install && yarn cache clean

  COPY . .
  ```

- Create the `docker-compose.yml`:
  ```yml
  version: '3'
  services:
    db:
      image: postgres:12.1-alpine
      expose:
        - "5432"
      volumes:
        - ./tmp/db:/var/lib/postgresql/data
    web:
      build: .
      command: bash -c "rm ./tmp/pids/server.pid ; yarn install ; rails s -p 3000 -b '0.0.0.0'"
      volumes:
        - .:/home/banana
      ports:
        - "3000:3000"
      expose:
        - "3000"
      depends_on:
        - db
  ```

- Run `docker-compose run web rails new . --database=postgresql --webpacker --webpack=react --skip-git --force`
  - This shall build the container image using our `Dockerfile`, and run `rails new` inside it.
    But as we setted up a volume inside our `docker-compose.yml`, we shall get the Rails scaffold put into our local folder.

- Run `docker-compose up` to run the app. Access `localhost:3000` on your browser. **You should see an error** about not being able to connect to the database.

- Modify the `config/database.yml` created by `rails new`. Change it to match the configurations below.
  - Pay attention that the `test` key will change from inheriting from `default` to inherit from `development`:
  ```yml
  default: &default
    adapter: postgresql
    encoding: unicode
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

  development: &development
    <<: *default
    database: deploy_development
    username: postgres
    password:
    host: db

  test:
    <<: *development
    database: deploy_test

  production:
    <<: *default
    database: deploy_production
    username: deploy
    password: <%= ENV['DEPLOY_DATABASE_PASSWORD'] %>
  ```

- Run the migrations, to create the database `docker-compose run web rails db:create db:migrate`. We have a volume configured for the postgres container, so the data will be stored between executions.

- Run the application again, `docker-compose up`. **Yay! You’re on Rails!**

- Later on, you can execute other things using the dependencies inside the container by running `docker-compose run web ...`

  - Eg. `docker-compose run web yarn add bootstrap jquery popper.js`
